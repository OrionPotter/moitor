<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨æ•°æ®ç®¡ç†</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 30px; }
        .main-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .text-end { text-align: right !important; }
        thead th {
            background-color: #e9ecef;
            font-weight: 600;
        }
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">ğŸ“Š è‚¡ç¥¨æ•°æ®ç®¡ç†</h2>
            <div>
                <a href="/" class="btn btn-outline-secondary me-2">ğŸ“ˆ æŠ•èµ„ç»„åˆ</a>
                <a href="/tools" class="btn btn-outline-secondary me-2">ğŸ› ï¸ æŠ•èµ„å·¥å…·</a>
                <a href="/monitor" class="btn btn-outline-secondary">ğŸ“Š åŠ ä»“ç›‘æ§</a>
            </div>
        </div>
        
        <!-- æ·»åŠ /ç¼–è¾‘è¡¨å• -->
        <div class="form-container">
            <h4 id="form-title">è‚¡ç¥¨èµ„äº§ç®¡ç†</h4>
            <form id="stock-form">
                <input type="hidden" id="edit-id" value="">
                <div class="row align-items-end">
                    <div class="col-md-3 mb-3">
                        <label for="code" class="form-label">è‚¡ç¥¨ä»£ç </label>
                        <input type="text" class="form-control" id="code" placeholder="ä¾‹å¦‚: sh600900, sz000895" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="name" class="form-label">è‚¡ç¥¨åç§°</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="cost_price" class="form-label">æˆæœ¬ä»·æ ¼</label>
                        <input type="number" class="form-control" id="cost_price" step="0.01" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="shares" class="form-label">æŒä»“è‚¡æ•°</label>
                        <input type="number" class="form-control" id="shares" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <button type="submit" class="btn btn-primary w-100">ä¿å­˜</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- è‚¡ç¥¨åˆ—è¡¨ -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>åç§°</th>
                        <th class="text-end">æˆæœ¬ä»·æ ¼</th>
                        <th class="text-end">æŒä»“è‚¡æ•°</th>
                        <th class="text-end">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stocks-table-body">
                    <tr><td colspan="5" class="text-center p-4 text-muted">æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- ç›‘æ§è‚¡ç¥¨ç®¡ç† -->
        <div class="form-container mt-5">
            <h4>ç›‘æ§è‚¡ç¥¨ç®¡ç†</h4>
            <form id="monitor-form">
                <input type="hidden" id="monitor-edit-id" value="">
                <div class="row align-items-end">
                    <div class="col-md-2 mb-3">
                        <label for="monitor-code" class="form-label">è‚¡ç¥¨ä»£ç </label>
                        <input type="text" class="form-control" id="monitor-code" placeholder="ä¾‹å¦‚: sh600900, sz000895" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="monitor-name" class="form-label">è‚¡ç¥¨åç§°</label>
                        <input type="text" class="form-control" id="monitor-name" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="monitor-timeframe" class="form-label">æ—¶é—´ç»´åº¦</label>
                        <select class="form-control" id="monitor-timeframe" required>
                            <option value="1d">æ—¥Kçº¿</option>
                            <option value="2d">2æ—¥Kçº¿</option>
                            <option value="3d">3æ—¥Kçº¿</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="monitor-reasonable-pe-min" class="form-label">åˆç†ä¼°å€¼(PE)æœ€å°å€¼</label>
                        <input type="number" class="form-control" id="monitor-reasonable-pe-min" step="0.1" value="15" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="monitor-reasonable-pe-max" class="form-label">åˆç†ä¼°å€¼(PE)æœ€å¤§å€¼</label>
                        <input type="number" class="form-control" id="monitor-reasonable-pe-max" step="0.1" value="20" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <button type="submit" class="btn btn-primary w-100">æ·»åŠ ç›‘æ§è‚¡ç¥¨</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- ç›‘æ§è‚¡ç¥¨åˆ—è¡¨ -->
        <div class="table-responsive mt-3">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>åç§°</th>
                        <th class="text-center">æ—¶é—´ç»´åº¦</th>
                        <th class="text-end">åˆç†ä¼°å€¼(PE)èŒƒå›´</th>
                        <th class="text-center">çŠ¶æ€</th>
                        <th class="text-end">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="monitor-table-body">
                    <tr><td colspan="6" class="text-center p-4 text-muted">æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let editingStock = null;
        let editingMonitorStock = null;
        
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ•°å­—ä¸ºé‡‘é¢å­—ç¬¦ä¸²
        function formatMoney(num) {
            if (num === undefined || num === null) return '-';
            return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // æ ¸å¿ƒå‡½æ•°ï¼šä» API è·å–è‚¡ç¥¨æ•°æ®å¹¶æ›´æ–°é¡µé¢
        async function loadStocks() {
            try {
                const response = await fetch('/api/admin/stocks');
                const result = await response.json();
                
                const tbody = document.getElementById('stocks-table-body');
                tbody.innerHTML = '';
                
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">æš‚æ— è‚¡ç¥¨æ•°æ®</td></tr>';
                    return;
                }
                
                result.data.forEach(stock => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name}</td>
                        <td class="text-end">${formatMoney(stock.cost_price)}</td>
                        <td class="text-end">${stock.shares.toLocaleString()}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editStock(${JSON.stringify(stock).replace(/"/g, '&quot;')})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStock('${stock.code}')">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("åŠ è½½è‚¡ç¥¨æ•°æ®å¤±è´¥:", error);
                document.getElementById('stocks-table-body').innerHTML = '<tr><td colspan="5" class="text-center text-danger p-4">åŠ è½½æ•°æ®å¤±è´¥</td></tr>';
            }
        }
        
        // æ·»åŠ æˆ–æ›´æ–°è‚¡ç¥¨
        async function saveStock(event) {
            event.preventDefault();
            
            const code = document.getElementById('code').value.trim();
            const name = document.getElementById('name').value.trim();
            const costPrice = document.getElementById('cost_price').value;
            const shares = document.getElementById('shares').value;
            
            if (!code || !name || !costPrice || !shares) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            const stockData = {
                code: code,
                name: name,
                cost_price: parseFloat(costPrice),
                shares: parseInt(shares)
            };
            
            let url, method;
            if (editingStock) {
                // æ›´æ–°ç°æœ‰è‚¡ç¥¨
                url = `/api/stocks/${editingStock.code}`;
                method = 'PUT';
            } else {
                // æ·»åŠ æ–°è‚¡ç¥¨
                url = '/api/stocks';
                method = 'POST';
            }
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stockData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(result.message);
                    resetForm();
                    loadStocks();
                } else {
                    alert(result.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error("ä¿å­˜è‚¡ç¥¨å¤±è´¥:", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // ç¼–è¾‘è‚¡ç¥¨
        function editStock(stock) {
            editingStock = stock;
            
            document.getElementById('form-title').textContent = 'ç¼–è¾‘è‚¡ç¥¨';
            document.getElementById('code').value = stock.code;
            document.getElementById('name').value = stock.name;
            document.getElementById('cost_price').value = stock.cost_price;
            document.getElementById('shares').value = stock.shares;
            
            // ç¦ç”¨ä»£ç å­—æ®µç¼–è¾‘
            document.getElementById('code').disabled = true;
        }
        
        // åˆ é™¤è‚¡ç¥¨
        async function deleteStock(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è‚¡ç¥¨ ${code} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/stocks/${code}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(result.message);
                    loadStocks();
                } else {
                    alert(result.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error("åˆ é™¤è‚¡ç¥¨å¤±è´¥:", error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('stock-form').reset();
            document.getElementById('form-title').textContent = 'æ·»åŠ è‚¡ç¥¨';
            document.getElementById('code').disabled = false;
            editingStock = null;
        }
        
        // ========== ç›‘æ§è‚¡ç¥¨ç®¡ç†åŠŸèƒ½ ==========
        
        // åŠ è½½ç›‘æ§è‚¡ç¥¨æ•°æ®
        async function loadMonitorStocks() {
            try {
                const response = await fetch('/api/admin/monitor-stocks');
                const result = await response.json();
                
                const tbody = document.getElementById('monitor-table-body');
                tbody.innerHTML = '';
                
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-muted">æš‚æ— ç›‘æ§è‚¡ç¥¨æ•°æ®</td></tr>';
                    return;
                }
                
                result.data.forEach(stock => {
                    const tr = document.createElement('tr');
                    const timeframeMap = {
                        '1d': 'æ—¥Kçº¿',
                        '2d': '2æ—¥Kçº¿',
                        '3d': '3æ—¥Kçº¿'
                    };
                    
                    const statusBadge = stock.enabled ? 
                        '<span class="badge bg-success">å¯ç”¨</span>' : 
                        '<span class="badge bg-secondary">ç¦ç”¨</span>';
                    
                    const peRange = `${stock.reasonable_pe_min || 15} - ${stock.reasonable_pe_max || 20}`;
                    
                    tr.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name}</td>
                        <td class="text-center">${timeframeMap[stock.timeframe] || stock.timeframe}</td>
                        <td class="text-end">${peRange}</td>
                        <td class="text-center">${statusBadge}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editMonitorStock(${JSON.stringify(stock).replace(/"/g, '&quot;')})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-${stock.enabled ? 'warning' : 'success'} me-2" onclick="toggleMonitorStock('${stock.code}', ${!stock.enabled})">${stock.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMonitorStock('${stock.code}')">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("åŠ è½½ç›‘æ§è‚¡ç¥¨æ•°æ®å¤±è´¥:", error);
                document.getElementById('monitor-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger p-4">åŠ è½½æ•°æ®å¤±è´¥</td></tr>';
            }
        }
        
        // ä¿å­˜ç›‘æ§è‚¡ç¥¨
        async function saveMonitorStock(event) {
            event.preventDefault();
            
            const code = document.getElementById('monitor-code').value.trim();
            const name = document.getElementById('monitor-name').value.trim();
            const timeframe = document.getElementById('monitor-timeframe').value;
            const reasonablePeMin = document.getElementById('monitor-reasonable-pe-min').value;
            const reasonablePeMax = document.getElementById('monitor-reasonable-pe-max').value;
            
            if (!code || !name || !timeframe || !reasonablePeMin || !reasonablePeMax) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            if (parseFloat(reasonablePeMin) >= parseFloat(reasonablePeMax)) {
                alert('åˆç†ä¼°å€¼æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                return;
            }
            
            const stockData = {
                code: code,
                name: name,
                timeframe: timeframe,
                reasonable_pe_min: parseFloat(reasonablePeMin),
                reasonable_pe_max: parseFloat(reasonablePeMax)
            };
            
            let url, method;
            if (editingMonitorStock) {
                // æ›´æ–°ç°æœ‰ç›‘æ§è‚¡ç¥¨
                url = `/api/admin/monitor-stocks/${editingMonitorStock.code}`;
                method = 'PUT';
                stockData.enabled = editingMonitorStock.enabled;
            } else {
                // æ·»åŠ æ–°ç›‘æ§è‚¡ç¥¨
                url = '/api/admin/monitor-stocks';
                method = 'POST';
            }
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stockData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(result.message);
                    resetMonitorForm();
                    loadMonitorStocks();
                } else {
                    alert(result.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error("ä¿å­˜ç›‘æ§è‚¡ç¥¨å¤±è´¥:", error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // ç¼–è¾‘ç›‘æ§è‚¡ç¥¨
        function editMonitorStock(stock) {
            editingMonitorStock = stock;
            
            document.getElementById('monitor-code').value = stock.code;
            document.getElementById('monitor-name').value = stock.name;
            document.getElementById('monitor-timeframe').value = stock.timeframe;
            document.getElementById('monitor-reasonable-pe-min').value = stock.reasonable_pe_min || 15;
            document.getElementById('monitor-reasonable-pe-max').value = stock.reasonable_pe_max || 20;
            
            // ç¦ç”¨ä»£ç å­—æ®µç¼–è¾‘
            document.getElementById('monitor-code').disabled = true;
        }
        
        // åˆ é™¤ç›‘æ§è‚¡ç¥¨
        async function deleteMonitorStock(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç›‘æ§è‚¡ç¥¨ ${code} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/monitor-stocks/${code}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(result.message);
                    loadMonitorStocks();
                } else {
                    alert(result.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error("åˆ é™¤ç›‘æ§è‚¡ç¥¨å¤±è´¥:", error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // å¯ç”¨/ç¦ç”¨ç›‘æ§è‚¡ç¥¨
        async function toggleMonitorStock(code, enabled) {
            try {
                const response = await fetch(`/api/admin/monitor-stocks/${code}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: enabled })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(result.message);
                    loadMonitorStocks();
                } else {
                    alert(result.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error("åˆ‡æ¢ç›‘æ§è‚¡ç¥¨çŠ¶æ€å¤±è´¥:", error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // é‡ç½®ç›‘æ§è¡¨å•
        function resetMonitorForm() {
            document.getElementById('monitor-form').reset();
            document.getElementById('monitor-code').disabled = false;
            editingMonitorStock = null;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadStocks();
            loadMonitorStocks();
            document.getElementById('stock-form').addEventListener('submit', saveStock);
            document.getElementById('monitor-form').addEventListener('submit', saveMonitorStock);
        });
    </script>
</body>
</html>